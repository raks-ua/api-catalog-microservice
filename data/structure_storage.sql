CREATE TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog` (
  `id` bigint(20) UNSIGNED NOT NULL,
  `key_id` int(10) UNSIGNED NOT NULL,
  `content` text NOT NULL,
  `content_hash` char(32) NOT NULL,
  `created` datetime NOT NULL,
  `updated` datetime NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_data` (
  `id` bigint(20) UNSIGNED NOT NULL,
  `catalog_id` bigint(20) UNSIGNED NOT NULL,
  `data` mediumtext NOT NULL,
  `created` datetime NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_pid` (
  `id` bigint(20) UNSIGNED NOT NULL,
  `catalog_id` bigint(20) UNSIGNED NOT NULL,
  `pid` bigint(20) UNSIGNED DEFAULT NULL,
  `created` datetime NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

ALTER TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `pid` (`key_id`,`content_hash`) USING BTREE,
  ADD KEY `fk_[SERVICE_APP_NAME]_catalog_key` (`key_id`);

ALTER TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_data`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `idx_uniq_[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_id` (`catalog_id`);

ALTER TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_pid`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `idx_uniq` (`pid`,`catalog_id`),
  ADD KEY `fk_[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_pid_catalog_id` (`catalog_id`);

ALTER TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog`
  MODIFY `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT;

ALTER TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_data`
  MODIFY `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT;

ALTER TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_pid`
  MODIFY `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT;

ALTER TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog`
  ADD CONSTRAINT `fk_[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_key` FOREIGN KEY (`key_id`) REFERENCES `[SERVICE_APP_NAME]_catalog_key` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;

ALTER TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_data`
  ADD CONSTRAINT `fk_[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_data_catalog_id` FOREIGN KEY (`catalog_id`) REFERENCES `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;

ALTER TABLE `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_pid`
  ADD CONSTRAINT `fk_[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_pid_catalog_id` FOREIGN KEY (`catalog_id`) REFERENCES `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION,
  ADD CONSTRAINT `fk_[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog_pid_pid` FOREIGN KEY (`pid`) REFERENCES `[SERVICE_APP_NAME]_[SERVICE_STORAGE]_catalog` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION;
